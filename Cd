WITH process_duration AS (
    SELECT
        p.task_id,
        t.hash,
        p.start_dt,
        p.end_dt,
        TIMESTAMPDIFF(SECOND, p.start_dt, p.end_dt) AS duration
    FROM processes p
    JOIN tasks t ON p.task_id = t.id
),
parallel_check AS (
    SELECT
        a.task_id,
        a.hash,
        a.start_dt,
        a.end_dt,
        a.duration,
        CASE 
            WHEN EXISTS (
                SELECT 1
                FROM process_duration b
                WHERE a.task_id = b.task_id
                  AND NOT (
                      a.end_dt <= b.start_dt OR
                      a.start_dt >= b.end_dt
                  )
                  AND NOT (
                      a.start_dt = b.start_dt AND a.end_dt = b.end_dt
                  )
            ) THEN 1 ELSE 0
        END AS is_parallel
    FROM process_duration a
),
aggregated AS (
    SELECT
        hash,
        COUNT(*) AS processes,
        SUM(is_parallel) AS total_parallel_processes,
        SUM(duration) AS total_usage_time,
        ROUND(SUM(
            CASE WHEN is_parallel = 1 THEN duration * 0.02 ELSE duration * 0.01 END
        ), 2) AS total_cost
    FROM parallel_check
    GROUP BY hash
)
SELECT *
FROM aggregated
ORDER BY hash;
